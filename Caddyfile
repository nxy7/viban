# Viban Caddyfile for local development with HTTPS/HTTP2
# This provides HTTPS for secure cookie handling, HTTP/2 for Electric SQL,
# and proper routing between frontend and backend.
#
# Usage:
#   # First time - trust local CA:
#   caddy trust
#
#   # Start Caddy:
#   caddy run --config Caddyfile
#
# Or with environment variable override:
#   CADDY_PORT=8080 BACKEND_PORT=7771 FRONTEND_PORT=3000 caddy run --config Caddyfile
#
# Access the app at: https://localhost:8000

{
	# Disable auto HTTPS redirect to avoid binding to port 80
	auto_https disable_redirects
}

localhost:{$CADDY_PORT:8000} {
	# Backend API routes
	handle /api/* {
		reverse_proxy localhost:{$BACKEND_PORT:7771}
	}

	# Auth routes (OAuth flow)
	handle /auth/* {
		reverse_proxy localhost:{$BACKEND_PORT:7771}
	}

	# MCP routes (for AI agents)
	handle /mcp/* {
		reverse_proxy localhost:{$BACKEND_PORT:7771}
	}

	# Tidewave MCP for AI debugging
	handle /tidewave/* {
		reverse_proxy localhost:{$BACKEND_PORT:7771}
	}

	# Phoenix WebSocket (for channels/live updates)
	handle /socket/* {
		reverse_proxy localhost:{$BACKEND_PORT:7771}
	}

	# Phoenix LiveView WebSocket
	handle /live/* {
		reverse_proxy localhost:{$BACKEND_PORT:7771}
	}

	# Vite HMR WebSocket - client router
	# The HMR server for client-side code runs on a separate port
	handle /_build/_hmr/client {
		reverse_proxy localhost:{$FRONTEND_HMR_CLIENT_PORT:3001}
	}

	# Vite HMR WebSocket - server router
	handle /_build/_hmr/server {
		reverse_proxy localhost:{$FRONTEND_HMR_SERVER_PORT:3002}
	}

	# Vite HMR WebSocket - server-function router
	handle /_build/_hmr/server-function {
		reverse_proxy localhost:{$FRONTEND_HMR_SERVER_FUNCTION_PORT:3003}
	}

	# Vite HMR WebSocket - SSR router
	handle /_build/_hmr/ssr {
		reverse_proxy localhost:{$FRONTEND_HMR_SSR_PORT:3004}
	}

	# Vite dev server assets (all other /_build/* paths)
	handle /_build/* {
		reverse_proxy localhost:{$FRONTEND_PORT:3000}
	}

	# Everything else goes to frontend
	handle {
		reverse_proxy localhost:{$FRONTEND_PORT:3000}
	}

	# Enable gzip compression
	encode gzip

	# Logs disabled by default to reduce noise
	# Uncomment to enable Caddy access logs:
	# log {
	# 	output stdout
	# 	format console
	# }
}
